# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#    listen 80;
#    listen [::]:80;
#
#    server_name example.com;
#
#    root /var/www/example.com;
#    index index.html;
#
#    location / {
#        try_files $uri $uri/ =404;
#    }
#}

# Use ip address as identifier for simul connections
# limit_conn_zone $binary_remote_addr zone=addr:10m;

#map $http_host $footer_file {
#    default            /footer.html;        #When not on cloudflare
#    mirror-cf.mwt.me    /footer-cf.html;    #Footer exclusive to cloudflare
#}
server {

    # SSL configuration
    #
    # listen 443 ssl default_server;
    # listen [::]:443 ssl default_server;
    #
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332
    #
    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782
    #
    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    #
    # include snippets/snakeoil.conf;

    root /srv/www/mirror.mwt.me;

    # Add index.php to the list if you are using PHP
    #index index.html index.htm index.nginx-debian.html;
    #index 7CjBnzJjPxp2nBPv;
    # autoindex on;

    server_name mirror.mwt.me mirror-ny-p.mwt.me mirror-ny-s.mwt.me mirror-lu-p.mwt.me mirror-lu-s.mwt.me;

    # set mime type to text
    default_type text/plain;

    location = / {
        return 301 https://www.matthewthom.as/mirrors/;
    }

    location / {
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_footer /fancyindex/footer.html;
        fancyindex_header /fancyindex/header.html;
        fancyindex_show_path off;
        fancyindex_time_format "%b %e, %Y";
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        try_files $uri $uri/ =404;
        # Rate/BW Limiting
        # allow 3 connections per IP (TeX/Deb are single threaded anyway)
        # limit_conn addr 3;
        # after 100MB, we will limit rate to 15MB/s (so 120Mb/s)
        #limit_rate_after 100m;
        #limit_rate 15m;
        # force revalidation, but allow cache
        # official Debian repos also use 2m
        expires 2m;
        # serve stale from if server is down for up to 12hr and for 6hr while revalidating
        add_header Cache-Control "stale-while-revalidate=21600, stale-if-error=43200, no-transform";

        location /fancyindex {
            internal;
        }

        location /assets {
            expires 4d;
        }

        location /ctan {
            # there could be binaries in ctan repo
            default_type application/octet-stream;
            add_header Surrogate-Control "max-age=21600";
        }

        # package files have version numbers in their names
        # should be cached for a long time
        location ~* \.(deb|rpm)$ {
            expires 1y;
        }

        # let's not cache index pages for too long
        location ~ /$ {
            expires 1m;
        }

        # Errors for legacy ghd
        location /ghd {
            location ~ ^/ghd/(gpgkey|install.sh)$ {
                return 410 'Error: this repository is depreciated by shiftkey please see: https://mirror.mwt.me/#github-desktop';
            }
        }
    }

    #    location ~ /fancyindex(/.*) {
    #        internal;
    #        root /var/www/fancyindex;
    #        try_files $1 $1/ =404;
    #    }
    #    location = /fancyindex/footer.html {
    #        internal;
    #        root /var/www/fancyindex;
    #        rewrite ^ "$footer_file" break;
    #    }

    # pass PHP scripts to FastCGI server
    #
    #location ~ \.php$ {
    #    include snippets/fastcgi-php.conf;
    #
    #    # With php-fpm (or other unix sockets):
    #    fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    #    # With php-cgi (or other tcp sockets):
    #    fastcgi_pass 127.0.0.1:9000;
    #}
    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny all;
    #}
    listen [::]:443 ssl;
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/mwt.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mwt.me/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    listen [::]:80;
    listen 80;
}
